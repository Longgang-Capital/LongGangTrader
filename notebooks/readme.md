### 回测框架介绍

在回测框架中，我们接收经过深度学习模型推理得出的权重，在历史行情数据中计算策略收益。

回测框架主要分为三个模块：策略模块、回测模块以及底层回测引擎

#### 策略模块

主要功能：接受因子或预测值数据，输出各资产的权重

##### 基础类 BaseStrategy

提供参数解析以及因子数据处理功能，自动对因子值进行滞后一期处理，避免未来函数

包含一次性生成权重与逐日生成权重两种抽象方法，供子类生成权重

##### 基于滚动分位数的信号加权 RollingTopQuantileStrategy

+ 三大主要参数：滚动时间窗口、分位数阈值、绝对值门槛
+ 实现逻辑：
  + 对因子值进行 N 日滚动平均
  + 计算每日的截面 Q 分位数 (如 Top 10%)
  + 筛选出：(滚动值 >= 当日分位数) 且 (滚动值 > 0) 的股票
  + 按照预测值占比进行归一化加权

#### 回测模块

+ 回测模块是连接交易信号与rust底层回测引擎的桥梁，也负责将回测的结果进行可视化
+ 在初始化回测器类Backtester的时候，可以在参数字典中配置交易成本、初始资金、调仓周期等
+ 回测器将会调用rust构建的回测函数，完成回测，得到polars.Dataframe格式的交易记录
+ 根据交易记录，回测器还可以计算收益指标、可视化净值曲线

#### 底层回测引擎

+ 底层回测引擎基于rust构建，回测的rust主函数将接收市场行情和交易信号，利用rust的高性能逐笔交易完成回测
+ rust主函数run_vectorized_backtest_rs从python代码中接收字符串格式的行情数据路径，以及交易信号数据。
  + rust的PyO3模块使得rust函数可以被包装成python函数供python调用，参数数据的传输也通过内存共享实现了零拷贝
+ rust函数加载数据后，首先将其解析为易于查找的HashMap结构，嵌套方式是 <日期,<代码,价格/信号>>，在每个交易日对每个股票进行遍历计算交易，将结果存储在PortfolioSnapshot中，最后将PortfolioSnapshot组成的向量整理成polars.Dataframe返回python
